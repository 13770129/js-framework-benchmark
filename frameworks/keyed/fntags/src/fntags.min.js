export const isNode=e=>e instanceof Node;export const fnstate=(e,t)=>{let n={},r=a(e),o=[];const s=[];let i;const l=function(e){if(0===arguments.length)return r;r=a(e);for(let t of o)t(e);return e};function a(e){if(Array.isArray(e)&&!e.__isProxy){let t=new Proxy(e,{get(e,t){if(parseInt(t.toString())==t){let r=e[t];r&&r.isFnState&&(r=r());let o=u(r,t);return n[o]?n[o]:n[o]=fnstate(r)}return Reflect.get(...arguments)},set(e,t,r){if(r&&r.isFnState&&(r=r()),parseInt(t.toString())==t&&s.length>0){let e=u(r,t);n[e]||(n[e]=fnstate(r))}return Reflect.set(...arguments)}});return Object.defineProperty(t,"__isProxy",{value:!0,enumerable:!1,writable:!1}),t}return e}function u(e,n){return"object"!=typeof e?e:t?t(e,n):n}function d(e){let t=Object.assign({},e.boundElementByKey),o=null,s=e.parent,l={};if(0!==r.length){for(let n=r.length-1;n>=0;n--){let i=r[n],a=u(i(),n);if(l[a])throw new Error("Duplicate keys in a bound array are not allowed.");l[a]=!0;let d=e.boundElementByKey[a],c=!1;d||(c=!0,d=e.boundElementByKey[a]=renderNode(evaluateElement(e.element,i)),d.key=a),o?o.previousSibling?o.previousSibling.key!==d.key&&(c?s.insertBefore(d,o):o.previousSibling.replaceWith(d)):s.insertBefore(d,o):s.lastChild&&s.lastChild.key===d.key||s.append(d),o=d,delete t[a]}for(let e of Object.keys(t))i===e&&(i=null),delete n[e],t[e].remove()}else s.textContent=""}function c(){for(let e of s)e.boundElementByKey||(e.boundElementByKey={}),d(e)}const f=(e,n)=>(!e.key&&t&&(e.key=u(r,n)),e);l.bindValues=(e,n,o)=>{if(!(e=renderNode(e)))throw new Error("You must provide a parent element to bind the children to. aka Need Bukkit.");if("function"!=typeof n&&!o)throw new Error("You must pass an update function when passing a non function element");if(t||(console.warn("Using value index as key, may not work correctly when moving items..."),t=(e,t)=>t),!Array.isArray(r))return l.bindAs(n,o);const i={element:n,update:o,parent:e};return s.push(i),l.subscribe(()=>{Array.isArray(r)?c():(console.warn("A state used with bindValues was updated to a non array value. This will be converted to an array of 1 and the state will be updated."),setTimeout(()=>l([r]),1))}),c(),e},l.bindAs=(e,t)=>{if("function"!=typeof e&&!t)throw new Error("You must pass an update function when passing a non function element");if(t){let n=renderNode(evaluateElement(e,r));return l.subscribe(()=>t(n)),n}return((e,t,n)=>{let r=f(renderNode(t()),n);return e.subscribe((function(){let e=f(renderNode(t()),n);e&&(e.key&&e.key===r.key||(r.replaceWith(e),r=e))})),r})(l,()=>e(r))};let y=new Event("deselect"),p=new Event("select");return l.select=e=>{for(let t of s)i&&t.boundElementByKey[i]&&t.boundElementByKey[i].dispatchEvent(y),i=e,t.boundElementByKey[e]&&t.boundElementByKey[e].dispatchEvent(p)},l.isFnState=!0,l.patch=e=>l(Object.assign(r,e)),l.subscribe=e=>o.push(e),l.reset=t=>{o=[],t&&(r=e)},l};const evaluateElement=(e,t)=>"function"==typeof e?e(t):e;export const renderNode=e=>{if("object"==typeof e&&void 0===e.then)return e;if("function"==typeof e.then){const e=marker();return e.then(t=>e.replaceWith(renderNode(t))).catch(e=>console.error("Caught failed node promise.",e)),e}return document.createTextNode(e+"")};export const h=(e,...t)=>{let n=document.createElement(e);if(isAttrs(t[0])){let e=t.shift();for(let t in e){let r=e[t];if("style"===t&&"object"==typeof r)for(let e in r){let t=r[e].toString().match(/(.*)\W+!important\W*$/);t?n.style.setProperty(e,t[1],"important"):n.style.setProperty(e,r[e])}else"value"===t||"string"==typeof r?n.setAttribute(t,r):t.startsWith("on")&&"function"==typeof r?n.addEventListener(t.substring(2),r):Object.defineProperty(n,t,{value:r,enumerable:!1})}}for(let e of t)if(Array.isArray(e))for(let t of e)n.append(renderNode(t));else n.append(renderNode(e));return n};export const isAttrs=e=>e&&"object"==typeof e&&!Array.isArray(e)&&!(e instanceof Node);export const getAttrs=e=>isAttrs(e[0])?e[0]:{};const marker=e=>h("div",Object.assign(e||{},{style:"display:none"}));